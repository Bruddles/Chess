function allowDrop(ev){ev.preventDefault()}function drag(ev){ev.dataTransfer.setData("text/html",ev.target.id),game.currentMove.possibleMoves=calcPossibleMoves(ev),highlightMoves(game.currentMove.possibleMoves)}function drop(ev){ev.preventDefault();var oldPosition=[],newPosition=[],data=ev.dataTransfer.getData("text/html");oldPosition=findPosition(data),newPosition=findArrayCoords(ev.target.id),isLegal(newPosition)&&(ev.target.appendChild(document.getElementById(data)),game.piecePos[oldPosition[0]][oldPosition[1]]=0,game.piecePos[newPosition[0]][newPosition[1]]=data,game.previousMoves.push([data,findCoords(oldPosition),ev.target.id]),socket.emit("newPreviousMoves",{newMoves:game.previousMoves})),unHighlightMoves(game.currentMove.possibleMoves)}function highlightMoves(possibleMoves){for(var i=0;i<possibleMoves.length;i++)$("#"+findCoords(possibleMoves[i])).css("background-color","yellow")}function unHighlightMoves(possibleMoves){for(var i=0;i<possibleMoves.length;i++)$("#"+findCoords(possibleMoves[i])).css("background-color","white")}function isLegal(newPosition){var possibleMoves=game.currentMove.possibleMoves;if(newPosition)for(var i=0;i<possibleMoves.length;i++)if(possibleMoves[i][0]==newPosition[0]&&possibleMoves[i][1]==newPosition[1])return!0;return!1}function calcPossibleMoves(ev){var position=[],moveTransforms=[],possibleMoves=[];switch(data=ev.target.id,game.currentMove.data=data,position=findPosition(data),game.currentMove.position=position,ev.target.className){case"pawn":moveTransforms=pawnMoveTransforms(position);break;case"rook":for(var i=0;8>i;i++)moveTransforms.push([0,i]),moveTransforms.push([0,-i]),moveTransforms.push([i,0]),moveTransforms.push([-i,0]);break;case"knight":moveTransforms=[[1,2],[-1,2],[1,-2],[-1,-2],[2,1],[-2,1],[2,-1],[-2,-1]];break;case"bishop":for(var i=0;8>i;i++)moveTransforms.push([i,i]),moveTransforms.push([i,-i]),moveTransforms.push([-i,i]),moveTransforms.push([-i,-i]);break;case"queen":for(var i=0;8>i;i++)moveTransforms.push([i,i]),moveTransforms.push([i,-i]),moveTransforms.push([-i,i]),moveTransforms.push([-i,-i]),moveTransforms.push([0,i]),moveTransforms.push([0,-i]),moveTransforms.push([i,0]),moveTransforms.push([-i,0]);break;case"king":moveTransforms=[[1,0],[1,1],[0,1],[1,-1],[0,1],[-1,-1],[-1,0],[-1,1]]}return possibleMoves=transform(position,moveTransforms)}function pawnMoveTransforms(position){var moveTransforms=[];if(0==game.previousMoves.length)moveTransforms.push([0,2]);else{for(var piecePreviouslyMoved=[],i=0;i<game.previousMoves.length;i++)piecePreviouslyMoved.push(game.previousMoves[i][0]);-1===piecePreviouslyMoved.indexOf(data)&&moveTransforms.push("B"==data.substring(0,1)?[0,-2]:[0,2])}return"B"==data.substring(0,1)?(moveTransforms.push([0,-1]),position[0]+1<=7&&position[1]-1>=0&&(console.log(position),console.log(game.piecePos[position[0]+1][position[1]+1]),game.piecePos[position[0]+1][position[1]-1]&&0!==game.piecePos[position[0]+1][position[1]-1]&&"W"===game.piecePos[position[0]+1][position[1]-1].substring(0,1)&&moveTransforms.push([1,-1])),position[0]-1>=0&&position[1]-1>=0&&game.piecePos[position[0]-1][position[1]-1]&&0!==game.piecePos[position[0]-1][position[1]-1]&&"W"===game.piecePos[position[0]-1][position[1]-1].substring(0,1)&&moveTransforms.push([-1,-1])):(moveTransforms.push([0,1]),position[0]+1<=7&&position[1]+1<=7&&game.piecePos[position[0]+1][position[1]+1]&&0!==game.piecePos[position[0]+1][position[1]+1]&&"B"===game.piecePos[position[0]+1][position[1]+1].substring(0,1)&&moveTransforms.push([1,1]),position[0]-1>=0&&position[1]+1<=7&&game.piecePos[position[0]-1][position[1]+1]&&0!==game.piecePos[position[0]-1][position[1]+1]&&"B"===game.piecePos[position[0]-1][position[1]+1].substring(0,1)&&moveTransforms.push([-1,1])),moveTransforms}function findPosition(id){for(var position=[],i=0;i<game.piecePos.length;i++)-1!==game.piecePos[i].indexOf(id)&&(position.push(i),position.push(game.piecePos[i].indexOf(id)));return position}function findCoords(position){var coords="";switch(position[0]){case 0:coords="a";break;case 1:coords="b";break;case 2:coords="c";break;case 3:coords="d";break;case 4:coords="e";break;case 5:coords="f";break;case 6:coords="g";break;case 7:coords="h"}return coords+=position[1]+1}function findArrayCoords(position){var coords=[];switch(position.toString().substring(0,1)){case"a":coords.push(0);break;case"b":coords.push(1);break;case"c":coords.push(2);break;case"d":coords.push(3);break;case"e":coords.push(4);break;case"f":coords.push(5);break;case"g":coords.push(6);break;case"h":coords.push(7)}return coords.push(Number(position.toString().substring(1,2))-1),coords}function transform(position,moveTransforms){for(var possibleMoves=[],i=0;i<moveTransforms.length;i++){var move;move=[position[0]+moveTransforms[i][0],position[1]+moveTransforms[i][1]],move[0]>=0&&move[0]<8&&move[1]>=0&&move[1]<8&&possibleMoves.push(move)}return possibleMoves}function updateBoard(){for(var i=0;i<game.previousMoves.length;i++){var position=findPosition(game.previousMoves[i][0]),newPosition=findArrayCoords(game.previousMoves[i][2]);position!==newPosition&&($("#"+game.previousMoves[i][0]).appendTo("#"+game.previousMoves[i][2]),game.piecePos[position[0]][position[1]]=0,game.piecePos[newPosition[0]][newPosition[1]]=game.previousMoves[i][0])}}function lockColour(){}var socket=io.connect("http://127.0.0.1:1337/"),app=app||{},game={currentMove:{data:"",position:[],possibleMoves:[]},previousMoves:[],piecePos:[["WR1","WP1",0,0,0,0,"BP1","BR1"],["WN1","WP2",0,0,0,0,"BP2","BN1"],["WB1","WP3",0,0,0,0,"BP3","BB1"],["WK1","WP4",0,0,0,0,"BP4","BK1"],["WQ1","WP5",0,0,0,0,"BP5","BQ1"],["WB2","WP6",0,0,0,0,"BP6","BB2"],["WN2","WP7",0,0,0,0,"BP7","BN2"],["WR2","WP8",0,0,0,0,"BP8","BR2"]]};socket.on("connect",function(){socket.emit("joinGame",{gameName:"test"})}),socket.on("sendMoveData",function(newPreviousMoves){game.previousMoves=newPreviousMoves.newMoves,updateBoard()});